
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>MarsBaR FAQ &#8212; MarsBaR 0.45 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=ef544bf2"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'faq';</script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Support" href="support.html" />
    <link rel="prev" title="Using a structural ROI" href="tutorial/andmore.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.45" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">MarsBaR 0.45 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="about.html">About MarsBaR</a></li>
<li class="toctree-l1"><a class="reference internal" href="download.html">Download and install</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="tutorial/index.html">MarsBaR tutorial</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial/gettingstarted.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial/interface.html">The MarsBaR / SPM interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial/define.html">Defining ROIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial/estimate.html">Running the ROI analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial/results.html">Basic results</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial/andmore.html">Using a structural ROI</a></li>


</ul>
</details></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">MarsBaR FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="development/index.html">Reading and writing MarsBaR code</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="development/code.html">Getting the latest development code</a></li>
<li class="toctree-l2"><a class="reference internal" href="development/apidocs.html">API documentation</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/marsbar-toolbox/marsbar" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/marsbar-toolbox/marsbar/issues/new?title=Issue%20on%20page%20%2Ffaq.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/faq.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>MarsBaR FAQ</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-s-with-the-fish">What’s with the fish?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-do-i-get-an-error-cant-open-image-file-when-estimating-a-design">Why do I get an error “Cant open image file” when estimating a design?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-is-the-percent-signal-change-calculated">How is the percent signal change calculated?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-run-a-marsbar-analysis-in-batch-mode">How do I run a MarsBaR analysis in batch mode?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-can-i-extract-the-percent-of-activated-voxels-from-an-roi">How can I extract the percent of activated voxels from an ROI?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-get-timecourses-from-images-in-an-spm-design">How do I get timecourses from images in an SPM design?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-just-want-to-get-raw-timecourses-from-some-images-how-do-i-do-that">I just want to get raw timecourses from some images; how do I do that?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-get-errors-using-the-spm-reml-estimation-for-fmri-designs-can-i-try-something-else">I get errors using the SPM ReML estimation for FMRI designs. Can I try something else?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-is-the-fir-or-psth-calculated">How is the FIR (or PSTH) calculated?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-extract-all-the-fir-timecourses-from-my-design">How do I extract all the FIR timecourses from my design?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-extract-percent-signal-change-from-my-design-using-batch">How do I extract percent signal change from my design using batch?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-do-a-random-effect-analysis-in-marsbar">How do I do a random effect analysis in MarsBaR?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#should-i-use-marsbar-roi-analysis-or-small-volume-correction-svc-in-spm">Should I use MarsBaR ROI analysis, or small volume correction (SVC) in SPM?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#should-i-use-smoothed-or-unsmoothed-images-for-my-marsbar-analysis">Should I use smoothed or unsmoothed images for my MarsBaR analysis?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-can-t-i-select-files-like-spm-designs-in-the-matlab-gui">Why can’t I select files like SPM designs in the matlab GUI?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-do-i-get-a-no-valid-data-for-roi-warning-when-extracting-data">Why do I get a “No valid data for roi” warning when extracting data?</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="marsbar-faq">
<h1>MarsBaR FAQ<a class="headerlink" href="#marsbar-faq" title="Link to this heading">#</a></h1>
<section id="what-s-with-the-fish">
<span id="fish"></span><h2>What’s with the fish?<a class="headerlink" href="#what-s-with-the-fish" title="Link to this heading">#</a></h2>
<p>When MarsBaR first starts, it flashes up a picture of a sardine. The
sardine is a symbol of Marseille, the spiritual home of MarsBaR. To
explain further, here’s an <a class="reference external" href="http://www.francemonthly.com/n/1002/index.php#article2">excerpt from France Monthly</a> online
magazine, entitled <strong>The Sardine That Blocked the Port Entrance</strong>.</p>
<blockquote>
<div><p>“We” say, in France (understanding that the “we” excludes the
people of Marseilles), that the people of Marseilles have a
tendency to exaggerate their stories. And it is stated, by these
local people, that one day a sardine (the little fish!) blocked
the entrance to the port. But this is not said in jest, a slight
distortion maybe! In 1778, the Viscount of Barras, officer of the
marine infantry regiment from Pondichery in India was captured by
the British. Benefiting from special accords for prisoner of war
exchanges, he embarked the following year on a boat, named the
“Sartine”, which was not armed. To prevent potential attacks upon
it, the captain would raise certain cartel flags that the enemy
would recognize. However, the rule was not respected, because on
May 1st, 10 months after being at sea without incident, a British
war boat attacked the “Sartine” with two fatal canon volleys. The
ship finished its trip and ran aground at the entrance to the old
port. It is therefore not a “sardine” that blocked the port of
Marseilles but a ship named “La Sartine”, on a beautiful spring
day in 1780!</p>
</div></blockquote>
</section>
<section id="why-do-i-get-an-error-cant-open-image-file-when-estimating-a-design">
<span id="cant-open"></span><h2>Why do I get an error “Cant open image file” when estimating a design?<a class="headerlink" href="#why-do-i-get-an-error-cant-open-image-file-when-estimating-a-design" title="Link to this heading">#</a></h2>
<p>This occurs when the filenames in your SPM or MarsBaR design no
longer point to valid files. For example, when you first estimated
the design, the time series images might have been in a directory
called <code class="docutils literal notranslate"><span class="pre">/now/dead/directory</span></code> - like this:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="nb">now</span><span class="o">/</span><span class="n">dead</span><span class="o">/</span><span class="n">directory</span><span class="o">/</span><span class="n">subject1</span><span class="o">/</span><span class="n">sess1</span><span class="o">/</span><span class="n">image_01</span><span class="p">.</span><span class="n">img</span>
<span class="o">/</span><span class="nb">now</span><span class="o">/</span><span class="n">dead</span><span class="o">/</span><span class="n">directory</span><span class="o">/</span><span class="n">subject1</span><span class="o">/</span><span class="n">sess1</span><span class="o">/</span><span class="n">image_02</span><span class="p">.</span><span class="n">img</span>
<span class="k">...</span>
<span class="o">/</span><span class="nb">now</span><span class="o">/</span><span class="n">dead</span><span class="o">/</span><span class="n">directory</span><span class="o">/</span><span class="n">subject1</span><span class="o">/</span><span class="n">sess2</span><span class="o">/</span><span class="n">image_01</span><span class="p">.</span><span class="n">img</span>
<span class="k">...</span>
<span class="o">/</span><span class="nb">now</span><span class="o">/</span><span class="n">dead</span><span class="o">/</span><span class="n">directory</span><span class="o">/</span><span class="n">subject2</span><span class="o">/</span><span class="n">sess1</span><span class="o">/</span><span class="n">image_01</span><span class="p">.</span><span class="n">img</span>
</pre></div>
</div>
<p>etc.</p>
<p>Time passed, you reorganized your files, and these images have now
moved to another directory, like this:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">currently</span><span class="o">/</span><span class="n">extant</span><span class="o">/</span><span class="nb">path</span><span class="o">/</span><span class="n">subject1</span><span class="o">/</span><span class="n">sess1</span><span class="o">/</span><span class="n">image_01</span><span class="p">.</span><span class="n">img</span>
<span class="o">/</span><span class="n">currently</span><span class="o">/</span><span class="n">extant</span><span class="o">/</span><span class="nb">path</span><span class="o">/</span><span class="n">subject1</span><span class="o">/</span><span class="n">sess1</span><span class="o">/</span><span class="n">image_02</span><span class="p">.</span><span class="n">img</span>
<span class="k">...</span>
<span class="o">/</span><span class="n">currently</span><span class="o">/</span><span class="n">extant</span><span class="o">/</span><span class="nb">path</span><span class="o">/</span><span class="n">subject1</span><span class="o">/</span><span class="n">sess2</span><span class="o">/</span><span class="n">image_01</span><span class="p">.</span><span class="n">img</span>
<span class="k">...</span>
<span class="o">/</span><span class="n">currently</span><span class="o">/</span><span class="n">extant</span><span class="o">/</span><span class="nb">path</span><span class="o">/</span><span class="n">subject2</span><span class="o">/</span><span class="n">sess1</span><span class="o">/</span><span class="n">image_01</span><span class="p">.</span><span class="n">img</span>
</pre></div>
</div>
<p>etc.</p>
<p>When you ask MarsBaR to estimate the original design, it looks for
<code class="docutils literal notranslate"><span class="pre">/now/dead/directory/subject1/sess1/image_01.img</span></code>, but the file does
not exist. To fix this, you will need to change the filenames in the
design to match the new image locations.</p>
<p>You can first check if this is the problem. Click on Design and choose
<em>Check image names in design</em>. You should see an error message in the
matlab console window if the images are not where the design says they
are.</p>
<p>Next, you need to find the correct root path to the images. The root
path is the shared common path for all the image names. In the above
example, the shared common path for the correct image filenames is
<code class="docutils literal notranslate"><span class="pre">/currently/extant/path</span></code>.</p>
<p>To do the fix, you click on Design and choose <em>Change design path to
images</em>. In the SPM input window you will see the current root
directory printed in bold text. In the example above, this would be:
<code class="docutils literal notranslate"><span class="pre">/now/dead/directory</span></code>.</p>
<p>You select <code class="docutils literal notranslate"><span class="pre">/currently/extant/path</span></code> using the SPM file selection
window that has just appeared. If all went well, you can check it has
worked; click Design, choose <em>Check image names in design</em> and hope that
you get the message <code class="docutils literal notranslate"><span class="pre">All</span> <span class="pre">images</span> <span class="pre">in</span> <span class="pre">design</span> <span class="pre">appear</span> <span class="pre">to</span> <span class="pre">exist</span></code> in the
matlab window.</p>
<p>The same thing from the command line would be:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">D</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mardo</span><span class="p">(</span><span class="s">&#39;/path/to/spm/mat/SPM.mat&#39;</span><span class="p">);</span>
<span class="n">D</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cd_images</span><span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;/currently/extant/path&#39;</span><span class="p">);</span>
<span class="n">save_spm</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="how-is-the-percent-signal-change-calculated">
<span id="percent-signal"></span><h2>How is the percent signal change calculated?<a class="headerlink" href="#how-is-the-percent-signal-change-calculated" title="Link to this heading">#</a></h2>
<p>Good question. Let us imagine that you had an FMRI design with one
event type, which is a flashing checkerboard. There is only one
session of data. The events are all modeled with a haemodynamic
response function (HRF) and the temporal derivative (TD). You run the
MarsBaR model on these data, for an ROI in the visual cortex. Now you
want the percent signal change.</p>
<p>Here’s how it goes. You select the event using the MarsBaR percent
signal change interface. MarsBaR does the following:</p>
<ol class="arabic simple">
<li><p>Finds the betas for this event. In this case the relevant betas
are the first two betas, the beta for the HRF, and the beta for
the TD.</p></li>
<li><p>Makes a new regressor for a single event. Remember that the best
estimate of the signal due to the event is the beta values for
this event multiplied by the regressors in the design matrix. So,
to reconstruct the height of a single event of this type, we need
to multiply the betas that we have calculated in the model by a
regressor which is like the SPM design matrix regressor in
scaling, but which is just for a single event. To do this we
specify the duration of the event we want to estimate the height
for, and run a single event of this duration back through the SPM
design matrix machinery, to make the regressor(s) SPM would have
used for just this single event. In this case we will get an HRF
regressor and a TD regressor.</p></li>
<li><p>Next we multiply the betas that we have by the regressors (HRF
beta * HRF regressor, TD beta * TD regressor), and sum up the two
resulting time courses, to get the estimated event response for a
single event of this event type. To get the size of the response,
for now, we just take the maximum height of the reconstructed
event. Let’s say this is about 0.2 units.</p></li>
<li><p>We’ve said 0.2 units, but units of what? SPM scales the mean of all
the in-brain voxels in the session to be 100 (see this <a class="reference external" href="http://imaging.mrc-cbu.cam.ac.uk/imaging/PrinciplesStatistics">SPM
statistics tutorial</a> for more detail on the scaling procedure). So,
0.2 units means 0.2 percent of the whole brain mean signal (in the
rather strange SPM sense). The problem with this is, that gray matter
has a higher signal than the brain average. In fact, if the whole
brain mean is 100, the gray matter signal tends to be about
180-200. We want to calculate signal change relative to the baseline
in this ROI, so we do not want to use the value 100 as the baseline,
we want to use the actual mean signal in this ROI, which will likely
be in the range of 180-200. The next step is therefore to get the
mean signal in the ROI. For this, we simply get the beta for the mean
column for this session. You remember that SPM removes the mean
signal within a session by using a session regressor which is just 1s
in the scans for this session and zeros elsewhere. These columns are
the last columns in the design matrix. In our case the mean column is
the third (and last) column, so, to get the session mean, we just
take the third (and last) beta. By doing this, we’ve ignored some
complexities, to do with the mean-centering of the regressors in the
design matrix, but let’s just quietly sweep that under the
carpet. There, all gone.</p></li>
<li><p>Let’s say our session mean was 192. Now, to get percent signal
change, we just divide 0.2 by 192. We get roughly 0.001. The last
step is to multiply by 100 to get percent signal change - which
gives (roughly) 0.1.</p></li>
</ol>
<p>The values you get may be rather small compared to reported values
for - say - signal change for a block of visual stimuation. In fact
you may well get signal change values that are less than 0.1 percent.
Your event may not be comparable to these reports. First, your events
may be short, which will of course give less maximum signal change
than a long block. Second, cognitive events usually give lower signal
change than events affecting primary motor or sensory cortex.</p>
</section>
<section id="how-do-i-run-a-marsbar-analysis-in-batch-mode">
<span id="marsbar-batch"></span><h2>How do I run a MarsBaR analysis in batch mode?<a class="headerlink" href="#how-do-i-run-a-marsbar-analysis-in-batch-mode" title="Link to this heading">#</a></h2>
<p>Here is a tiny example of a batch mode script. It assumes you have a
design which has been estimated in SPM, and has a set of contrasts
specified.</p>
<p>This example script assumes your design is stored in
<code class="docutils literal notranslate"><span class="pre">/my/path/SPM.mat</span></code> and you have an ROI stored in
<code class="docutils literal notranslate"><span class="pre">/my/path/my_roi.mat</span></code>:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">spm_name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;/my/path/SPM.mat&#39;</span><span class="p">;</span>
<span class="n">roi_file</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;/my/path/my_roi.mat&#39;</span><span class="p">;</span>

<span class="c">% Make marsbar design object</span>
<span class="n">D</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">mardo</span><span class="p">(</span><span class="n">spm_name</span><span class="p">);</span>
<span class="c">% Make marsbar ROI object</span>
<span class="n">R</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">maroi</span><span class="p">(</span><span class="n">roi_file</span><span class="p">);</span>
<span class="c">% Fetch data into marsbar data object</span>
<span class="n">Y</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">get_marsy</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;mean&#39;</span><span class="p">);</span>
<span class="c">% Get contrasts from original design</span>
<span class="n">xCon</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_contrasts</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
<span class="c">% Estimate design on ROI data</span>
<span class="n">E</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">estimate</span><span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">);</span>
<span class="c">% Put contrasts from original design back into design object</span>
<span class="n">E</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">set_contrasts</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">xCon</span><span class="p">);</span>
<span class="c">% get design betas</span>
<span class="n">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">betas</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
<span class="c">% get stats and stuff for all contrasts into statistics structure</span>
<span class="n">marsS</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">compute_contrasts</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">xCon</span><span class="p">));</span>
</pre></div>
</div>
<p>See the help for the <a class="reference external" href="./apidocs/marsbar/&#64;mardo_99/compute_contrasts.html">compute_contrasts</a> function for details on the
contents of the marsS structure.</p>
</section>
<section id="how-can-i-extract-the-percent-of-activated-voxels-from-an-roi">
<h2>How can I extract the percent of activated voxels from an ROI?<a class="headerlink" href="#how-can-i-extract-the-percent-of-activated-voxels-from-an-roi" title="Link to this heading">#</a></h2>
<p>There is no easy way of doing this using the MarsBaR GUI, but you can
do it using scipts like this one:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">roi_file</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;my_roi.mat&#39;</span><span class="p">;</span>
<span class="n">t_imgs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">strvcat</span><span class="p">(</span><span class="s">&#39;spmT_0002.img&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;spmT_0003.img&#39;</span><span class="p">);</span>
<span class="n">thresholds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mf">3.4</span><span class="w"> </span><span class="mf">4.6</span><span class="p">];</span>
<span class="n">roi_obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">maroi</span><span class="p">(</span><span class="n">roi_file</span><span class="p">);</span>
<span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getdata</span><span class="p">(</span><span class="n">roi_obj</span><span class="p">,</span><span class="w"> </span><span class="n">t_imgs</span><span class="p">);</span>
<span class="n">n_voxels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">t_imgs</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">pc_above_thresh</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="nb">i</span><span class="p">,:)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">thresholds</span><span class="p">(</span><span class="nb">i</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_voxels</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="how-do-i-get-timecourses-from-images-in-an-spm-design">
<span id="design-timecourse"></span><h2>How do I get timecourses from images in an SPM design?<a class="headerlink" href="#how-do-i-get-timecourses-from-images-in-an-spm-design" title="Link to this heading">#</a></h2>
<p>In the GUI, choose Data - Extract ROI data (default). Select your
ROIs and your design (if you had not set it previously). MarsBaR
extracts the data; you can then plot it or save it in various formats
using Data - Export. In script form, this would be something like:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">roi_files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_get</span><span class="p">(</span><span class="nb">Inf</span><span class="p">,</span><span class="s">&#39;*roi.mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Select ROI files&#39;</span><span class="p">);</span>
<span class="n">des_path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_get</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;SPM.mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Select SPM.mat&#39;</span><span class="p">);</span>
<span class="n">rois</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">maroi</span><span class="p">(</span><span class="s">&#39;load_cell&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">roi_files</span><span class="p">);</span><span class="w"> </span><span class="c">% make maroi ROI objects</span>
<span class="n">des</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mardo</span><span class="p">(</span><span class="n">des_path</span><span class="p">);</span><span class="w">  </span><span class="c">% make mardo design object</span>
<span class="n">mY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_marsy</span><span class="p">(</span><span class="n">rois</span><span class="p">{:},</span><span class="w"> </span><span class="n">des</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;mean&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% extract data into marsy data object</span>
<span class="n">y</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">summary_data</span><span class="p">(</span><span class="n">mY</span><span class="p">);</span><span class="w">  </span><span class="c">% get summary time course(s)</span>
</pre></div>
</div>
</section>
<section id="i-just-want-to-get-raw-timecourses-from-some-images-how-do-i-do-that">
<span id="raw-timecourse"></span><h2>I just want to get raw timecourses from some images; how do I do that?<a class="headerlink" href="#i-just-want-to-get-raw-timecourses-from-some-images-how-do-i-do-that" title="Link to this heading">#</a></h2>
<p>This can be done from the GUI. Select Data - Extract ROI data (full
options). Select the ROIs, say No to use SPM design, Other for type
of images, 1 for number of subjects. Select the images you want to
extract data from, Raw data for scaling, and 0 for grand mean. Now
you can plot the data from the GUI, or save in various formats using
Data - Export data. The script to do this might be:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">roi_files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_get</span><span class="p">(</span><span class="nb">Inf</span><span class="p">,</span><span class="s">&#39;*roi.mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Select ROI files&#39;</span><span class="p">);</span>
<span class="n">P</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_get</span><span class="p">(</span><span class="nb">Inf</span><span class="p">,</span><span class="s">&#39;*.img&#39;</span><span class="p">,</span><span class="s">&#39;Select images&#39;</span><span class="p">);</span>
<span class="n">rois</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">maroi</span><span class="p">(</span><span class="s">&#39;load_cell&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">roi_files</span><span class="p">);</span><span class="w">  </span><span class="c">% make maroi ROI objects</span>
<span class="n">mY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_marsy</span><span class="p">(</span><span class="n">rois</span><span class="p">{:},</span><span class="w"> </span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;mean&#39;</span><span class="p">);</span><span class="w">  </span><span class="c">% extract data into marsy data object</span>
<span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">summary_data</span><span class="p">(</span><span class="n">mY</span><span class="p">);</span><span class="w"> </span><span class="c">% get summary time course(s)</span>
</pre></div>
</div>
</section>
<section id="i-get-errors-using-the-spm-reml-estimation-for-fmri-designs-can-i-try-something-else">
<span id="fmristat"></span><h2>I get errors using the SPM ReML estimation for FMRI designs. Can I try something else?<a class="headerlink" href="#i-get-errors-using-the-spm-reml-estimation-for-fmri-designs-can-i-try-something-else" title="Link to this heading">#</a></h2>
<p>Why yes, in fact you can. MarsBaR includes the AR modelling from Keith
Worsley’s <a class="reference external" href="http://www.math.mcgill.ca/keith/fmristat">fmristat program</a>, which is a good
alternative to the standard SPM ReML for FMRI. To use this, load your
design in the GUI, then choose Design - Add/Edit filter for SPM
design. Set the high-pass filter as you wish, and then choose “fmristat
AR(n)” for serial autocorrelations. Set the order of the model (AR(1),
AR(2) etc) - 2 is a good choice. Estimate the model in the usual way.</p>
<p>In batch mode this would look like:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Make marsbar design object</span>
<span class="n">D</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="n">mardo</span><span class="p">(</span><span class="n">spm_name</span><span class="p">);</span>
<span class="c">% Set fmristat AR modelling</span>
<span class="n">D</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">autocorr</span><span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;fmristat&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="how-is-the-fir-or-psth-calculated">
<span id="fir-info"></span><h2>How is the FIR (or PSTH) calculated?<a class="headerlink" href="#how-is-the-fir-or-psth-calculated" title="Link to this heading">#</a></h2>
<p>MarsBaR and SPM use FIR models to calculate the PSTH (peri-stimulus time
histogram). By default, the FIR models have a time bin of one TR. Let us
imagine your TR is one second, as is your FIR time-bin.  You can then
think of the FIR as calculating the best estimate of the signal 0
seconds, 1 seconds, 2 seconds after the event has occurred, and after
adjusting for other effects in the model.</p>
<p>As this is just a very similar approach to averaging, there is no
constraint that the signal should be at zero at 0 seconds. Just for
example, random noise will mean than the average signal at 0 seconds
will not be exactly zero.</p>
<p>For more information on the FIR method used for the PSTH, you might
want to have a look at these papers:</p>
<blockquote>
<div><p>Ollinger JM, Shulman GL, Corbetta M. Separating processes within a
trial in event-related functional MRI. Neuroimage. 2001
Jan;13(1):210-7.</p>
<p>Dale AM. Optimal experimental design for event-related fMRI. Hum
Brain Mapp. 1999;8(2-3):109-14.</p>
</div></blockquote>
<p>Russ Poldrack also has a useful page on <a class="reference external" href="http://sourceforge.net/docman/display_doc.php?docid=6217&amp;group_id=13529">FIR modelling</a>.</p>
</section>
<section id="how-do-i-extract-all-the-fir-timecourses-from-my-design">
<span id="extract-fir"></span><h2>How do I extract all the FIR timecourses from my design?<a class="headerlink" href="#how-do-i-extract-all-the-fir-timecourses-from-my-design" title="Link to this heading">#</a></h2>
<p>You can of course do this via the GUI. The most efficient is to do it
with a batch script. You have already run the batch script above up
to <code class="docutils literal notranslate"><span class="pre">E</span> <span class="pre">=</span> <span class="pre">estimate(D,</span> <span class="pre">Y);</span></code>. Then:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Get definitions of all events in model</span>
<span class="p">[</span><span class="n">e_specs</span><span class="p">,</span><span class="w"> </span><span class="n">e_names</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">event_specs</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
<span class="n">n_events</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">e_specs</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="c">% Bin size in seconds for FIR</span>
<span class="n">bin_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tr</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
<span class="c">% Length of FIR in seconds</span>
<span class="n">fir_length</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span>
<span class="c">% Number of FIR time bins to cover length of FIR</span>
<span class="n">bin_no</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fir_length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bin_size</span><span class="p">;</span>
<span class="c">% Options - here &#39;single&#39; FIR model, return estimated</span>
<span class="n">opts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;single&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;percent&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="c">% Return time courses for all events in fir_tc matrix</span>
<span class="k">for</span><span class="w"> </span><span class="n">e_s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_events</span>
<span class="w">  </span><span class="n">fir_tc</span><span class="p">(:,</span><span class="w"> </span><span class="n">e_s</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">event_fitted_fir</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">e_specs</span><span class="p">(:,</span><span class="n">e_s</span><span class="p">),</span><span class="w"> </span><span class="n">bin_size</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                 </span><span class="n">bin_no</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">);</span>
<span class="k">end</span>
</pre></div>
</div>
<p>If your events have the same name across sessions, and you want to
average across the events with the same name:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Get compound event types structure</span>
<span class="n">ets</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">event_types_named</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
<span class="n">n_event_types</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">ets</span><span class="p">);</span>
<span class="c">% Bin size in seconds for FIR</span>
<span class="n">bin_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tr</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
<span class="c">% Length of FIR in seconds</span>
<span class="n">fir_length</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span>
<span class="c">% Number of FIR time bins to cover length of FIR</span>
<span class="n">bin_no</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fir_length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bin_size</span><span class="p">;</span>
<span class="c">% Options - here &#39;single&#39; FIR model, return estimated % signal change</span>
<span class="n">opts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;single&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;percent&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="n">e_t</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_event_types</span>
<span class="w">   </span><span class="n">fir_tc</span><span class="p">(:,</span><span class="w"> </span><span class="n">e_t</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">event_fitted_fir</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">ets</span><span class="p">(</span><span class="n">e_t</span><span class="p">).</span><span class="n">e_spec</span><span class="p">,</span><span class="w"> </span><span class="n">bin_size</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">      </span><span class="n">bin_no</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">);</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="how-do-i-extract-percent-signal-change-from-my-design-using-batch">
<span id="extract-pct"></span><h2>How do I extract percent signal change from my design using batch?<a class="headerlink" href="#how-do-i-extract-percent-signal-change-from-my-design-using-batch" title="Link to this heading">#</a></h2>
<p>Maybe something like this:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Get definitions of all events in model</span>
<span class="p">[</span><span class="n">e_specs</span><span class="p">,</span><span class="w"> </span><span class="n">e_names</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">event_specs</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
<span class="n">n_events</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">e_specs</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="n">dur</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="c">% Return percent signal esimate for all events in design</span>
<span class="k">for</span><span class="w"> </span><span class="n">e_s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_events</span>
<span class="w">  </span><span class="n">pct_ev</span><span class="p">(</span><span class="n">e_s</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">event_signal</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">e_specs</span><span class="p">(:,</span><span class="n">e_s</span><span class="p">),</span><span class="w"> </span><span class="n">dur</span><span class="p">);</span>
<span class="k">end</span>
</pre></div>
</div>
<p>See also the documentation for <a class="reference external" href="./apidocs/marsbar/&#64;mardo/event_signal.html">event_signal.m</a>.</p>
</section>
<section id="how-do-i-do-a-random-effect-analysis-in-marsbar">
<span id="rfx"></span><h2>How do I do a random effect analysis in MarsBaR?<a class="headerlink" href="#how-do-i-do-a-random-effect-analysis-in-marsbar" title="Link to this heading">#</a></h2>
<p>There are two ways to do this.</p>
<ol class="arabic simple">
<li><p>Do your ROI analysis for each subject. From the GUI, or via batch
mode, extract the “contrast value” for your t contrast of
interest. Put these values into a matlab matrix, with one value
per subject (to take the simplest case). You have two ways to go
from there. Either export this matrix to a spreadsheet or text
file, and run the statistics using another statistics program, or
load the SPM random effects design into MarsBaR, import your
matlab matrix as the data, and run the random effects analysis in
MarsBaR.</p></li>
<li><p>Run the full SPM analysis for each subject. Write out the contrast
image for the contrast of interest. Run the random effects design
in SPM. Then, import the random effects design into MarsBaR, and
run it using your ROI. Here you are extracting the (e.g.) mean
contrast value within the ROI for each subject, and using that as
your estimate of the effect for that subject.</p></li>
</ol>
<p>If you do ordinary least squares (OLS) analyses at the single-subject
level, these two approaches will give you the exact same answer. OLS
is the analysis that does not try to correct for auto-correlation in
the data.</p>
<p>If you did not use OLS, then the first approach is more valid, as in
this case, you have estimated the autocorrelation from the ROI
itself, rather than the whole (activated) brain, which is the default
SPM approach.</p>
<p>OLS at the single subject level is valid (is not biased), but is
likely to be less powerful than the alternative (which is removing
the autocorrelation - “whitening”). In practice the difference
between using and not using OLS is often small.</p>
<p>The first approach also saves you having to run the SPM models at the
single subject level, but you have often done this in any case.</p>
</section>
<section id="should-i-use-marsbar-roi-analysis-or-small-volume-correction-svc-in-spm">
<span id="svc"></span><h2>Should I use MarsBaR ROI analysis, or small volume correction (SVC) in SPM?<a class="headerlink" href="#should-i-use-marsbar-roi-analysis-or-small-volume-correction-svc-in-spm" title="Link to this heading">#</a></h2>
<p>Good question - thanks for asking. The two approaches will give
answers to different questions. MarsBaR asks something like “does
area A on average activate more for condition 1 than condition 2”,
whereas SVC asks “given I am only looking within the voxels of area
A, are there any voxels in A that I can be confident are more active
in condition 1 than condition 2”. Thus, if you have a good idea of
the region you are interested in, and believe that the response
should be relatively homogenous across the region, then the MarsBaR
question is likely to be the closest to the one you want to answer.
However, if you do not have a good idea of the exact definition of
the region you are interested in, and think there may will be
different responses in different parts of the region that you define,
then you might prefer SVC, which can detect peaks of activity even if
the rest of the region is not activated, or even is negative.</p>
<p>Of course, the meaning of the results is slightly different. SVC
allows you to say that some part of your candidate region is active
(allowing for example that most of it could be deactivated). MarsBaR
would likely find no significant change in that situation.</p>
<p>Summary: which you prefer depends on the exact question you want to
answer, which in turn depends on the region definition that you are
using.</p>
</section>
<section id="should-i-use-smoothed-or-unsmoothed-images-for-my-marsbar-analysis">
<span id="smoothed"></span><h2>Should I use smoothed or unsmoothed images for my MarsBaR analysis?<a class="headerlink" href="#should-i-use-smoothed-or-unsmoothed-images-for-my-marsbar-analysis" title="Link to this heading">#</a></h2>
<p>Of course, you can also think of using smoothed images as using a
smoothed version of your ROI definition. Deciding whether to smooth is a
trade-off between trying to:</p>
<ol class="arabic simple">
<li><p>increase voxel-to-voxel signal to noise, and</p></li>
<li><p>avoid polluting region signal by signal from nearby structures.</p></li>
</ol>
<p>So, if your region definition is a conservative one in the centre of
a large structure that you believe to be homogenous, then you might
opt for image smoothing, on the basis that the risk from nearby
signal is rather small. If your region was well-defined, and
surrounded by other things such as CSF that you really wanted to
avoid, you would probably choose unsmoothed images. The hippocampus
strikes me as a good example of the latter…</p>
</section>
<section id="why-can-t-i-select-files-like-spm-designs-in-the-matlab-gui">
<span id="uigetfile"></span><h2>Why can’t I select files like SPM designs in the matlab GUI?<a class="headerlink" href="#why-can-t-i-select-files-like-spm-designs-in-the-matlab-gui" title="Link to this heading">#</a></h2>
<p>If you are running matlab 7 on Linux, you may have difficulty with
the matlab GUI routines that MarsBaR uses to select files, like SPM
designs and ROI data.</p>
<p>This is caused by a bug in matlab. You may find documentation for this
by searching the Matlab site with the terms “uigetfile linux”. It’s a
bizarre bug, which causes matlab to appear not to find files when you
click on them in the matlab “uigetfile” interface that MarsBaR uses. If
you are using the default method of running matlab, which uses the fancy
Java desktop, you can get round it using the workaround documented at
the link above, which is to run the following command:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">setappdata</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;UseNativeSystemDialogs&#39;</span><span class="p">,</span><span class="nb">false</span><span class="p">)</span>
</pre></div>
</div>
<p>in matlab, before you ever start a file selection dialog, such as those
in MarsBaR. Future versions of MarsBaR will do this automatically. This
fix doesn’t work if you are running in non-Java mode - which is what you
get if you start matlab with <code class="docutils literal notranslate"><span class="pre">matlab</span> <span class="pre">-nojvm</span></code>.  In that case, you will
need to either select the file using the keyboard, rather than the
mouse, or type the file name directly into the file selection box. There
are some other odd wrinkles to the behaviour of the uigetfile interface
in matlab 7, which should be fixed in marsbar version 0.40 and
above. For details, search for comments containing ‘uigetfile’ in
<a class="reference external" href="./apidocs/marsbar/mars_uifile.html">mars_uifile.m</a>.</p>
</section>
<section id="why-do-i-get-a-no-valid-data-for-roi-warning-when-extracting-data">
<span id="novalid"></span><h2>Why do I get a “No valid data for roi” warning when extracting data?<a class="headerlink" href="#why-do-i-get-a-no-valid-data-for-roi-warning-when-extracting-data" title="Link to this heading">#</a></h2>
<p>You might run into a warning like this:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">roi</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">...</span>
</pre></div>
</div>
<p>This is almost invariably because you are sampling from SPM results
images, that have NaNs at the edges of the brain. Marsbar uses linear
resampling by default to get the data from the images, so voxels at
the edge of the brain disappear due to resampling with NaN values.
The fix is to change the ROI resampling to nearest neighbour using
something like:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">roi_filename</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;my_roi.mat&#39;</span><span class="p">;</span>
<span class="n">my_roi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">maroi</span><span class="p">(</span><span class="n">roi_filename</span><span class="p">);</span>
<span class="n">my_roi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_hold</span><span class="p">(</span><span class="n">my_roi</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c">% set NN resampling</span>
<span class="n">saveroi</span><span class="p">(</span><span class="n">my_roi</span><span class="p">,</span><span class="w"> </span><span class="n">roi_filename</span><span class="p">);</span>
</pre></div>
</div>
<p>and then rerun the data extraction…</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tutorial/andmore.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Using a structural ROI</p>
      </div>
    </a>
    <a class="right-next"
       href="support.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Support</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-s-with-the-fish">What’s with the fish?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-do-i-get-an-error-cant-open-image-file-when-estimating-a-design">Why do I get an error “Cant open image file” when estimating a design?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-is-the-percent-signal-change-calculated">How is the percent signal change calculated?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-run-a-marsbar-analysis-in-batch-mode">How do I run a MarsBaR analysis in batch mode?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-can-i-extract-the-percent-of-activated-voxels-from-an-roi">How can I extract the percent of activated voxels from an ROI?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-get-timecourses-from-images-in-an-spm-design">How do I get timecourses from images in an SPM design?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-just-want-to-get-raw-timecourses-from-some-images-how-do-i-do-that">I just want to get raw timecourses from some images; how do I do that?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-get-errors-using-the-spm-reml-estimation-for-fmri-designs-can-i-try-something-else">I get errors using the SPM ReML estimation for FMRI designs. Can I try something else?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-is-the-fir-or-psth-calculated">How is the FIR (or PSTH) calculated?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-extract-all-the-fir-timecourses-from-my-design">How do I extract all the FIR timecourses from my design?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-extract-percent-signal-change-from-my-design-using-batch">How do I extract percent signal change from my design using batch?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-i-do-a-random-effect-analysis-in-marsbar">How do I do a random effect analysis in MarsBaR?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#should-i-use-marsbar-roi-analysis-or-small-volume-correction-svc-in-spm">Should I use MarsBaR ROI analysis, or small volume correction (SVC) in SPM?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#should-i-use-smoothed-or-unsmoothed-images-for-my-marsbar-analysis">Should I use smoothed or unsmoothed images for my MarsBaR analysis?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-can-t-i-select-files-like-spm-designs-in-the-matlab-gui">Why can’t I select files like SPM designs in the matlab GUI?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-do-i-get-a-no-valid-data-for-roi-warning-when-extracting-data">Why do I get a “No valid data for roi” warning when extracting data?</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2000-2025, Matthew Brett.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>